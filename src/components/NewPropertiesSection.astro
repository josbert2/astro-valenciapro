---
interface Property {
    title: string;
    uri: string;
    featuredImage?: {
        node: {
            sourceUrl: string;
            altText?: string;
        }
    };
    realEstatePropertyAddress?: string;
    realEstatePropertyBedrooms?: number;
    realEstatePropertyBathrooms?: number;
    realEstatePropertyGarage?: number;
    realEstatePropertyPriceShort?: string;
    valenciaPriceUnit?: string;
}

interface Props {
    title?: string;
    subtitle?: string;
    limit?: number;
}

const {
    title = "Nuevas propiedades",
    subtitle = "¡Lo nuevo en arriendo y venta te está esperando!",
    limit = 4
} = Astro.props;

const apiUrl = import.meta.env.WP_DOMAIN || 'http://localhost:10016';
---

<section class="new-properties-section">
    <div class="max-w-7xl mx-auto px-4 lg:px-8">
        
        <!-- Header -->
        <div class="text-center mb-16">
            <h2 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-3">{title}</h2>
            {subtitle && <p class="section-subtitle">{subtitle}</p>}
        </div>

        <!-- Properties Grid -->
        <div id="new-properties-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Skeleton loaders -->
            {[1, 2, 3, 4].map(() => (
                <div class="skeleton-card">
                    <div class="skeleton-card-inner">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-location"></div>
                            <div class="skeleton-features">
                                <div class="skeleton-feature"></div>
                                <div class="skeleton-feature"></div>
                                <div class="skeleton-feature"></div>
                            </div>
                            <div class="skeleton-footer">
                                <div class="skeleton-price"></div>
                                <div class="skeleton-btn"></div>
                            </div>
                        </div>
                    </div>
                </div>
            ))}
        </div>

        <!-- CTA Button -->
        <div class="text-center mt-16">
            <a href="/propiedades" class="cta-btn group">
                Ver más propiedades
                <span class="icon-circle">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </span>
            </a>
        </div>
    </div>
</section>

<script define:vars={{ apiUrl, limit }}>
    async function loadNewProperties() {
        const container = document.getElementById('new-properties-grid');
        if (!container) return;

        try {
            const response = await fetch(`https://cms.valenciapro.cl/graphql`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: `{
                        properties(first: 20, where: { orderby: { field: DATE, order: DESC } }) {
                            nodes {
                                title
                                uri
                                featuredImage {
                                    node {
                                        sourceUrl
                                        altText
                                    }
                                }
                                realEstatePropertyAddress
                                realEstatePropertyBedrooms
                                realEstatePropertyBathrooms
                                realEstatePropertyGarage
                                realEstatePropertyPriceShort
                                valenciaPriceUnit
                                realEstatePropertyOperation
                                propertyStatus
                            }
                        }
                    }`
                })
            });

            const { data } = await response.json();
            let allProperties = data?.properties?.nodes || [];
            
            // Filter: ONLY show disponible (hide arrendada, reservada, vendida, etc.)
            // Logic sync with PropertiesSection: allow 'disponible' OR 'arrendada' but status badge logic handles display
            const filteredProperties = allProperties.filter(p => {
                const status = (p.propertyStatus || 'disponible').toLowerCase();
                 return status === 'disponible' || status === 'arrendada';
            });
            
            // Limit to desired amount after filtering
            const properties = filteredProperties.slice(0, limit);

            if (properties.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 col-span-2">No hay propiedades disponibles.</p>';
                return;
            }

            container.innerHTML = properties.map(property => {
                const imageUrl = property.featuredImage?.node?.sourceUrl || '/placeholder.jpg';
                const altText = property.featuredImage?.node?.altText || property.title;
                const address = property.realEstatePropertyAddress || 'Santiago, Chile';
                const bedrooms = property.realEstatePropertyBedrooms || 0;
                const bathrooms = property.realEstatePropertyBathrooms || 0;
                const garage = property.realEstatePropertyGarage || 0;
                const price = property.realEstatePropertyPriceShort || 'Consultar';
                const unit = property.valenciaPriceUnit || '';
                
                const formattedPrice = unit ? `${unit} ${parseInt(price).toLocaleString('es-CL')}` : `$ ${parseInt(price).toLocaleString('es-CL')}`;

                // Extract slug and build correct URL
                const slug = property.uri ? property.uri.replace(/^\/propiedades\//, '').replace(/\/$/, '') : '';
                const propertyUrl = slug ? `/propiedad/${slug}` : '#';
                
                // Status Logic (Badge Top Left)
                const statusSlug = (property.propertyStatus || 'disponible').toLowerCase();
                const statusName = statusSlug.charAt(0).toUpperCase() + statusSlug.slice(1);
                
                const statusConfig = {
                    'disponible': { bg: '#FFFFFF', text: '#BFB37B', dot: '#BFB37B' }, // White/Gold (Elegant)
                    'arrendada': { bg: '#E7E5E4', text: '#57534E', dot: '#A8A29E' }  // Sand/Taupe (Warm Neutral)
                };
                const sColor = statusConfig[statusSlug] || statusConfig['disponible'];

                const statusBadge = `
                    <span class="absolute top-4 left-4 z-10 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider shadow-sm" style="background: ${sColor.bg}; color: ${sColor.text}">
                        <span class="w-2 h-2 rounded-full" style="background: ${sColor.dot}"></span>
                        ${statusName}
                    </span>
                `;

                // Operation Logic (Badge Top Right)
                const opSlug = (property.realEstatePropertyOperation || 'Arriendo').toLowerCase();
                const opName = opSlug.charAt(0).toUpperCase() + opSlug.slice(1);
                
                const opConfig = {
                    'arriendo': { bg: '#BFB37B', text: '#FFFFFF', dot: '#FFFFFF' }, // Gold/White
                    'venta':    { bg: '#6B9E7B', text: '#FFFFFF', dot: '#D1E7DD' }  // Soft Sage Green (Light Premium)
                };
                const oColor = opConfig[opSlug] || opConfig['arriendo'];

                // Hide operation badge if property is already rented (arrendada) to avoid redundancy/contradiction
                const operationBadge = statusSlug === 'arrendada' ? '' : `
                    <div class="absolute top-4 right-4 z-10">
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider shadow-sm" style="background: ${oColor.bg}; color: ${oColor.text}">
                             <span class="w-2 h-2 rounded-full" style="background: ${oColor.dot}"></span>
                            ${opName}
                        </span>
                    </div>
                `;

                return `
                    <div class="property-card group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="property-card-inner relative">
                            <div class="property-image-wrapper relative h-[300px] overflow-hidden">
                                <img src="${imageUrl}" alt="${altText}" class="property-image w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy" />
                                ${statusBadge}
                                ${operationBadge}
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                                
                                <div class="property-actions absolute right-4 top-1/2 -translate-y-1/2 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 translate-x-4 group-hover:translate-x-0">
                                   <!-- Actions could go here -->
                                </div>
                            </div>
                            
                            <div class="property-content p-6">
                                <h3 class="property-title text-xl font-bold text-gray-900 mb-2 line-clamp-1">
                                    <a href="${propertyUrl}" class="hover:text-[#BFB37B] transition-colors">${property.title}</a>
                                </h3>
                                
                                ${address ? `
                                    <p class="property-location text-gray-500 text-sm flex items-center gap-2 mb-4">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                            <circle cx="12" cy="10" r="3"/>
                                        </svg>
                                        ${address}
                                    </p>
                                ` : ''}

                                <div class="property-features flex gap-4 text-gray-600 text-sm mb-6 pb-6 border-b border-gray-100">
                                    ${bedrooms > 0 ? `
                                        <div class="feature-item flex items-center gap-1.5" title="${bedrooms} Habitaciones">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                            <span class="font-medium">${bedrooms}</span>
                                        </div>
                                    ` : ''}
                                    ${bathrooms > 0 ? `
                                        <div class="feature-item flex items-center gap-1.5" title="${bathrooms} Baños">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6a3 3 0 0 1 6 0v3"/><circle cx="12" cy="12" r="9"/></svg>
                                            <span class="font-medium">${bathrooms}</span>
                                        </div>
                                    ` : ''}
                                    ${garage > 0 ? `
                                        <div class="feature-item flex items-center gap-1.5" title="${garage} Estacionamientos">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="13" rx="2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>
                                            <span class="font-medium">${garage}</span>
                                        </div>
                                    ` : ''}
                                </div>

                                <div class="property-footer flex justify-between items-center">
                                    <div class="property-price text-xl font-bold text-[#BFB37B]">${formattedPrice}</div>
                                    <a href="${propertyUrl}" class="btn-details inline-flex items-center justify-center px-4 py-2 border border-[#BFB37B] text-[#BFB37B] text-sm font-medium rounded-lg hover:bg-[#BFB37B] hover:text-white transition-colors duration-300">
                                        Detalles
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading properties:', error);
            container.innerHTML = '<p class="text-center text-red-500 col-span-2">Error al cargar propiedades.</p>';
        }
    }

    loadNewProperties();
</script>

