---
interface Props {
    title?: string;
    subtitle?: string;
    limit?: number;
    showFilters?: boolean;
}

const {
    title = "Propiedades disponibles",
    subtitle = "Explora los nuevos espacios pensados para tu estilo de vida.",
    limit = 6,
    showFilters = true
} = Astro.props;

const apiUrl = import.meta.env.WP_DOMAIN || 'http://localhost:10016';
---

<section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-3">{title}</h2>
            {subtitle && <p class="text-gray-500 max-w-2xl mx-auto">{subtitle}</p>}
        </div>

        <div id="filters-container" class="flex flex-wrap justify-center gap-2 mb-10 hidden"></div>

        <div id="properties-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[1,2,3,4,5,6].map(() => (
                <div class="skeleton-card bg-white rounded-2xl overflow-hidden shadow-lg">
                    <div class="h-[500px] bg-gray-200 animate-pulse"></div>
                    <div class="absolute bottom-0 left-0 right-0 p-6 space-y-3">
                        <div class="h-5 bg-gray-300/50 rounded w-3/4 animate-pulse"></div>
                        <div class="h-4 bg-gray-300/50 rounded w-1/2 animate-pulse"></div>
                        <div class="flex gap-3 pt-2 border-t border-gray-300/30">
                            <div class="h-4 bg-gray-300/50 rounded w-16 animate-pulse"></div>
                            <div class="h-4 bg-gray-300/50 rounded w-16 animate-pulse"></div>
                            <div class="h-4 bg-gray-300/50 rounded w-16 animate-pulse"></div>
                        </div>
                        <div class="flex justify-between items-center pt-3">
                            <div class="h-6 bg-gray-300/50 rounded w-24 animate-pulse"></div>
                            <div class="h-8 bg-gray-300/50 rounded w-28 animate-pulse"></div>
                        </div>
                    </div>
                </div>
            ))}
        </div>

        <div class="text-center mt-12">
            <a href="/propiedades" class="group inline-flex items-center gap-4 bg-gray-900 text-white pl-8 pr-3 py-3 rounded-full font-medium hover:bg-primary transition-all duration-300 hover:-translate-y-1">
                Ver más propiedades
                <span class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-gray-900 transition-transform group-hover:rotate-[-45deg]">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </span>
            </a>
        </div>
    </div>
</section>

<style>
    .skeleton-card {
        position: relative;
        height: 500px;
    }
</style>

<script define:vars={{ apiUrl, limit }}>
    async function loadProperties() {
        const container = document.getElementById('properties-container');
        const filtersContainer = document.getElementById('filters-container');
        
        try {
            const response = await fetch(`https://cms.valenciapro.cl/graphql`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: `{
                        properties(first: 20) {
                            nodes {
                                title
                                uri
                                featuredImage { node { sourceUrl } }
                                realEstatePropertyType
                                realEstatePropertyOperation
                                realEstatePropertyPriceShort
                                valenciaPriceUnit
                                realEstatePropertyAddress
                                realEstatePropertyBathrooms
                                realEstatePropertyBedrooms
                                realEstatePropertyGarage
                                realEstatePropertySize
                                realEstatePropertyFloorNumber
                                propertyStatus
                            }
                        }
                    }`
                })
            });

            const { data } = await response.json();
            let allProperties = data?.properties?.nodes || [];
            
            // Filter: ONLY show disponible (hide arrendada, reservada, vendida, en-mantenimiento)
            const filteredProperties = allProperties.filter(p => {
                const status = (p.propertyStatus || 'disponible', 'arrendada').toLowerCase();
                return status === 'disponible' || status === 'arrendada';
            });
            
            const properties = filteredProperties.slice(0, limit);

            if (properties.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500"><p>No hay propiedades disponibles.</p></div>';
                return;
            }

            const types = [...new Set(properties.map(p => (p.realEstatePropertyType || 'departamento').toLowerCase()))];
            
            if (types.length > 1) {
                filtersContainer.classList.remove('hidden');
                filtersContainer.innerHTML = `
                    <button class="filter-btn active px-5 py-1.5 rounded-lg bg-[#BFB37B] text-white text-sm font-light" data-filter="*">Ver todo</button>
                    ${types.map(t => `<button class="filter-btn px-5 py-1.5 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm font-light hover:border-[#BFB37B]" data-filter=".type-${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</button>`).join('')}
                `;
                setupFilters();
            }

            container.innerHTML = properties.map(p => {
                const type = (p.realEstatePropertyType || 'departamento').toLowerCase();
                const operation = p.realEstatePropertyOperation || 'Arriendo';
                const opColor = operation.toLowerCase() === 'venta' ? 'bg-[#2f2f2f]' : 'bg-[#BFB37B]';
                const price = p.valenciaPriceUnit ? `${p.valenciaPriceUnit} ${formatNum(p.realEstatePropertyPriceShort)}` : `$ ${formatNum(p.realEstatePropertyPriceShort)}`;
                const img = p.featuredImage?.node?.sourceUrl || '/hero-1.jpg';
                // Extract slug from uri and use /propiedad/ path
                const slug = p.uri ? p.uri.replace(/^\/propiedades\//, '').replace(/\/$/, '') : '';
                const propertyUrl = slug ? `/propiedad/${slug}` : '#';
                
                // Status Logic
                const statusSlug = (p.propertyStatus || 'disponible').toLowerCase();
                const statusName = statusSlug.charAt(0).toUpperCase() + statusSlug.slice(1);
                const statusColors = {
                    'disponible': { bg: '#bfb37b', dot: '#9a8f5c' },
                    'arrendada': { bg: '#c07b59', dot: '#9a8f5c' }
                };
                const colors = statusColors[statusSlug] || statusColors['disponible'] || statusColors['arrendada'];
                
                // Status Badge HTML to insert
                const statusBadge = `
                    <span class="absolute top-4 left-4 z-10 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold text-white uppercase tracking-wider shadow-sm" style="background: ${colors.bg}">
                        <span class="w-2 h-2 rounded-full animate-pulse" style="background: ${colors.dot}"></span>
                        ${statusName}
                    </span>
                `;
                
                let features = '';
                if (p.realEstatePropertyBathrooms) {
                    features += `<span class="text-sm text-white/80 flex items-center gap-1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                        ${p.realEstatePropertyBathrooms} Baños
                    </span>`;
                }
                if (p.realEstatePropertyGarage) {
                    features += `<span class="text-sm text-white/80 flex items-center gap-1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 17H4C3.46957 17 2.96086 16.7893 2.58579 16.4142C2.21071 16.0391 2 15.5304 2 15V6C2 5.46957 2.21071 4.96086 2.58579 4.58579C2.96086 4.21071 3.46957 4 4 4H20C20.5304 4 21.0391 4.21071 21.4142 4.58579C21.7893 4.96086 22 5.46957 22 6V15C22 15.5304 21.7893 16.0391 21.4142 16.4142C21.0391 16.7893 20.5304 17 20 17H19"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>
                        ${p.realEstatePropertyGarage} Garajes
                    </span>`;
                }
                if (p.realEstatePropertyFloorNumber) {
                    features += `<span class="text-sm text-white/80 flex items-center gap-1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6H21M3 12H21M3 18H21"/></svg>
                        Piso ${p.realEstatePropertyFloorNumber}
                    </span>`;
                }
                if (p.realEstatePropertySize) {
                    features += `<span class="text-sm text-white/80 flex items-center gap-1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18"/></svg>
                        ${p.realEstatePropertySize}
                    </span>`;
                }
                
                return `
                <div class="property-item type-${type}">
                    <div class="group relative bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 h-full">
                        <div class="relative h-[500px] overflow-hidden">
                            <img src="${img}" alt="${p.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy"/>
                            ${statusBadge}
                            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent"></div>
                            <div class="absolute top-4 right-4">
                                <span class="${opColor} text-white px-4 py-1.5 rounded-md text-xs font-semibold capitalize">${operation}</span>
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 p-6 text-white z-10">
                            <h3 class="text-xl font-semibold mb-2 line-clamp-1">
                                <a href="${propertyUrl}" class="hover:text-[#BFB37B] transition-colors">${p.title}</a>
                            </h3>
                            <p class="text-sm text-white/80 flex items-center gap-2 mb-4">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                ${p.realEstatePropertyAddress || 'Santiago, Chile'}
                            </p>
                            <div class="grid grid-cols-3 gap-3 py-3 border-t border-b    border-white/20 mb-4">
                                ${features}
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-light text-[#BFB37B]">${price}</span>
                                <a href="${propertyUrl}" class="text-[#BFB37B] text-sm font-medium hover:underline px-8 border border-[#BFB37B] rounded-lg py-2">
                                    Detalles →
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500"><p>Error cargando propiedades.</p></div>';
        }
    }

    function formatNum(n) {
        if (!n) return '0';
        return Number(n).toLocaleString('es-CL');
    }

    function setupFilters() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('active', 'bg-[#BFB37B]', 'text-white');
                    b.classList.add('bg-white', 'text-gray-700');
                });
                btn.classList.add('active', 'bg-[#BFB37B]', 'text-white');
                btn.classList.remove('bg-white', 'text-gray-700');
                
                const filter = btn.getAttribute('data-filter');
                document.querySelectorAll('.property-item').forEach(item => {
                    item.style.display = (filter === '*' || item.classList.contains(filter.replace('.', ''))) ? 'block' : 'none';
                });
            });
        });
    }

    loadProperties();
</script>
