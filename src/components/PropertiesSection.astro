---
import PropertyCard from './PropertyCard.astro';
import { propertiesQuery } from '../lib/api';
import { formatPrice, formatSize } from '../lib/utils';

interface Props {
    title?: string;
    subtitle?: string;
    limit?: number;
    showFilters?: boolean;
}

const {
    title = "Propiedades disponibles",
    subtitle = "Explora los nuevos espacios pensados para tu estilo de vida.",
    limit = 6,
    showFilters = true
} = Astro.props;

let properties = [];
let types: string[] = [];

try {
    const rawProperties = await propertiesQuery(limit);
    
    properties = rawProperties.map((p: any) => ({
        title: p.title || 'Sin título',
        location: p.realEstatePropertyAddress || 'Santiago, Chile',
        price: formatPrice(p.realEstatePropertyPriceShort, p.valenciaPriceUnit),
        operation: p.realEstatePropertyOperation || 'Arriendo',
        image: p.featuredImage?.node?.sourceUrl || '/hero-1.jpg',
        url: p.uri || '#',
        bathrooms: parseInt(p.realEstatePropertyBathrooms) || undefined,
        bedrooms: parseInt(p.realEstatePropertyBedrooms) || undefined,
        garages: parseInt(p.realEstatePropertyGarage) || undefined,
        floor: p.realEstatePropertyFloorNumber || undefined,
        size: formatSize(p.realEstatePropertySize || p.realEstatePropertyLand),
        type: (p.realEstatePropertyType || 'departamento').toLowerCase().replace(/\s+/g, '-')
    }));

    types = [...new Set(properties.map((p: any) => p.type))];
} catch (error) {
    console.error('Error fetching properties:', error);
}
---

<section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-3">{title}</h2>
            {subtitle && <p class="text-gray-500 max-w-2xl mx-auto">{subtitle}</p>}
        </div>

        {showFilters && types.length > 1 && (
            <div class="flex flex-wrap justify-center gap-2 mb-10">
                <button 
                    class="filter-btn active px-5 py-1.5 rounded-lg bg-primary text-white text-sm font-light transition-all"
                    data-filter="*"
                >
                    Ver todo
                </button>
                {types.map(type => (
                    <button 
                        class="filter-btn px-5 py-1.5 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm font-light transition-all hover:border-primary hover:text-primary"
                        data-filter={`.type-${type}`}
                    >
                        {type?.charAt(0).toUpperCase() + type?.slice(1).replace(/-/g, ' ')}
                    </button>
                ))}
            </div>
        )}

        {properties.length > 0 ? (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 properties-grid">
                {properties.map((property: any) => (
                    <PropertyCard {...property} />
                ))}
            </div>
        ) : (
            <div class="text-center py-12 text-gray-500">
                <p>No hay propiedades disponibles en este momento.</p>
            </div>
        )}

        <div class="text-center mt-12">
            <a 
                href="/propiedades" 
                class="group inline-flex items-center gap-4 bg-gray-900 text-white pl-8 pr-3 py-3 rounded-full font-medium hover:bg-primary transition-all duration-300 hover:-translate-y-1"
            >
                Ver más propiedades
                <span class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-gray-900 transition-transform group-hover:rotate-[-45deg]">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </span>
            </a>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const filterBtns = document.querySelectorAll('.filter-btn');
        const items = document.querySelectorAll('.property-item');
        
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => {
                    b.classList.remove('active', 'bg-primary', 'text-white');
                    b.classList.add('bg-white', 'text-gray-700', 'border-gray-200');
                });
                btn.classList.add('active', 'bg-primary', 'text-white');
                btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
                
                const filter = btn.getAttribute('data-filter');
                
                items.forEach(item => {
                    if (filter === '*' || item.classList.contains(filter?.replace('.', '') || '')) {
                        (item as HTMLElement).style.display = 'block';
                    } else {
                        (item as HTMLElement).style.display = 'none';
                    }
                });
            });
        });
    });
</script>
