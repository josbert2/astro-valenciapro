---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

import { SEO } from "astro-seo";

// Props del layout
interface Props {
    title?: string;
    description?: string;
    image?: string;
    noindex?: boolean;
}

// Use Astro.site (from astro.config.mjs) or current URL origin
const siteUrl = import.meta.env.SITE_URL || Astro.url.origin;
const appEnv = import.meta.env.APP_ENV || "development";

const allowIndexing = appEnv === "production";
const robotsContent = allowIndexing ? "index, follow" : "noindex, nofollow";

const { 
    title, 
    description = "Encuentra tu propiedad ideal en Santiago, Chile. Casas, departamentos y oficinas en arriendo y venta con Valencia Propiedades.", 
    image,
    noindex = false
} = Astro.props;

const isIndexPage = Astro.url.pathname === "/";

const SITE_NAME = "Valencia Propiedades";
const DEFAULT_TITLE = "Valencia Propiedades | Corretaje Inmobiliario en Santiago";

const pageTitle = isIndexPage ? DEFAULT_TITLE : title || DEFAULT_TITLE;
const titleTemplate = isIndexPage ? "%s" : `%s | ${SITE_NAME}`;

const ogParams = new URLSearchParams({
    tag: 'valenciapro.cl',
    title: pageTitle,
    subtitle: description,
});

// Use custom image if provided, otherwise generate default
const defaultOgImage = `${siteUrl}/api/og.png?${ogParams.toString()}`;
const ogImage = image || defaultOgImage;
---



<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="google-site-verification" content="sWGA5eug6k6Zf1UyPLcS7exxX2Hx8pX3uFKJrfwihNk">
        <meta name="application-name" content="ValenciaPro">
        <meta name="apple-mobile-web-app-title" content="ValenciaPro">
        <SEO
            title={pageTitle}
            titleDefault={DEFAULT_TITLE}
            titleTemplate={titleTemplate}
            description={description}
            canonical={Astro.url.toString()}
            noindex={noindex || !allowIndexing}
            nofollow={noindex || !allowIndexing}
            openGraph={{
                basic: {
                    title: pageTitle,
                    type: "website",
                    image: ogImage,
                    url: Astro.url.toString(),
                },
                image: {
                    alt: SITE_NAME,
                    width: 1200,
                    height: 630,
                    type: "image/png",
                },
                optional: {
                    description,
                    siteName: SITE_NAME,
                    locale: "es_CL",
                },
            }}
            twitter={{
                card: "summary_large_image",
                site: "@valenciapropiedades",
                creator: "@valenciapropiedades",
                title: pageTitle,
                description,
                image: ogImage,
                imageAlt: SITE_NAME,
            }}
            extend={{
                meta: [
                    { name: "author", content: "Valencia Propiedades" },
                    {
                        name: "keywords",
                        content: "propiedades, inmobiliaria, corretaje, arriendo, venta, departamentos, casas, santiago, chile",
                    },
                    { name: "googlebot", content: robotsContent },
                    { name: "theme-color", content: "#bfb37b" },
                    { name: "msapplication-TileColor", content: "#bfb37b" },
                ],
                link: [
                    {
                        rel: "apple-touch-icon",
                        sizes: "180x180",
                        href: "/apple-touch-icon.png",
                    },
                    {
                        rel: "icon",
                        type: "image/png",
                        sizes: "32x32",
                        href: "/favicon-32x32.png",
                    },
                    {
                        rel: "icon",
                        type: "image/png",
                        sizes: "16x16",
                        href: "/favicon-16x16.png",
                    },
                    {
                        rel: "icon",
                        type: "image/png",
                        sizes: "96x96",
                        href: "/favicon-96x96.png",
                    },
                    {
                        rel: "icon",
                        type: "image/x-icon",
                        href: "/favicon.ico",
                    },
                    {
                        rel: "icon",
                        type: "image/svg+xml",
                        href: "/favicon.svg",
                    },
                    {
                        rel: "icon",
                        type: "image/png",
                        sizes: "192x192",
                        href: "/android-chrome-192x192.png",
                    },
                    {
                        rel: "icon",
                        type: "image/png",
                        sizes: "512x512",
                        href: "/android-chrome-512x512.png",
                    },
                    {
                        rel: "manifest",
                        href: "/site.webmanifest",
                    },
                ],
            }}
        />
        <link rel="sitemap" href="/sitemap-index.xml" />
        
        <!-- Preload fonts for performance -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet" />
        
        <!-- WhatsApp Sticky Button Styles -->
        <style is:global>
            .valencia-whatsapp-sticky {
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 9999;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
                opacity: 0;
                transform: translateY(20px);
                animation: waFadeIn 0.5s ease forwards 1s;
            }
            .valencia-wa-btn {
                width: 60px;
                height: 60px;
                background-color: #25d366;
                color: #fff;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                text-decoration: none;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                position: relative;
            }
            .valencia-wa-btn:hover {
                background-color: #bfb37b;
                transform: scale(1.1);
            }
            .valencia-wa-tooltip {
                background-color: #fff;
                color: #2d3436;
                padding: 10px 18px;
                border-radius: 12px;
                border-bottom-right-radius: 4px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 10px;
                margin-right: 10px;
                opacity: 0;
                transform: translateX(-10px);
                animation: waTooltipIn 0.5s ease forwards 2s;
            }
            .valencia-wa-tooltip strong { color: #25d366; }
            .wa-tooltip-close {
                cursor: pointer;
                opacity: 0.5;
                font-size: 16px;
            }
            .wa-tooltip-close:hover { opacity: 1; }
            .wa-pulse, .wa-pulse-2 {
                position: absolute;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                border: 2px solid #25d366;
                opacity: 0;
                animation: waPulseAnim 2s infinite;
                pointer-events: none;
            }
            .wa-pulse-2 { animation-delay: 0.5s; }
            .valencia-wa-btn:hover .wa-pulse,
            .valencia-wa-btn:hover .wa-pulse-2 { border-color: #bfb37b; }
            @keyframes waFadeIn {
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes waTooltipIn {
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes waPulseAnim {
                0% { transform: scale(1); opacity: 0.5; }
                100% { transform: scale(1.6); opacity: 0; }
            }
            @media (max-width: 768px) {
                .valencia-whatsapp-sticky { bottom: 20px; right: 20px; }
                .valencia-wa-btn { width: 55px; height: 55px; }
                .valencia-wa-tooltip { display: none; }
            }
        </style>
        
        <!-- Slot for page-specific head content (JSON-LD, etc) -->
        <slot name="head" />
    </head>
    <body class="bg-white text-gray-900 antialiased">
        <Header />
        <slot />
        <Footer />
        
        <!-- WhatsApp Sticky Button -->
        <div id="valencia-whatsapp-sticky" class="valencia-whatsapp-sticky">
            <div class="valencia-wa-tooltip">
                <span class="wa-tooltip-text">¿Necesitas asesoría? <strong>¡Hablemos!</strong></span>
                <div class="wa-tooltip-close">×</div>
            </div>
            <a href="https://wa.me/56993373237?text=Hola%2C+me+interesa+conocer+m%C3%A1s+sobre+las+propiedades+de+Valencia+Pro." target="_blank" class="valencia-wa-btn" aria-label="Contactar por WhatsApp">
                <svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                <span class="wa-pulse"></span>
                <span class="wa-pulse-2"></span>
            </a>
        </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const closeBtn = document.querySelector('.wa-tooltip-close');
                const tooltip = document.querySelector('.valencia-wa-tooltip');
                if (closeBtn && tooltip) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        tooltip.style.display = 'none';
                    });
                }
            });
        </script>
    </body>
</html>
