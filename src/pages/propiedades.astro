---
import Layout from '../layouts/main.astro';
import Header from '../components/Header.astro';
import '../styles/propiedades.css';

const mapboxToken = 'pk.eyJ1Ijoiam9zYmVydCIsImEiOiJjbWlzYmR0b3MxN3RnM2hvYnFuZzYzeHhrIn0.IcQTlfA5pb6QtSL7TsUX5A';
const apiUrl = 'https://cms.valenciapro.cl';

// Get query params for client-side filtering
const url = new URL(Astro.request.url);
const keyword = url.searchParams.get('keyword') || '';
const operation = url.searchParams.get('operation') || '';
const type = url.searchParams.get('type') || '';
const status = url.searchParams.get('status') || '';
const bedrooms = url.searchParams.get('bedrooms') || '';
---

<Layout 
    title="Propiedades" 
    description="Explora nuestra selección de propiedades en arriendo y venta en Santiago, Chile."
>

    
    <section class="properties-page">
        <!-- Map Section -->
        <div class="map-wrapper">
            <div id="properties-map"></div>
        </div>
        
        <!-- Main Content -->
        <div class="properties-content">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                
                <!-- Search Bar -->
                <div class="search-bar">
                    <form method="get" action="/propiedades" class="search-form" id="search-form">
                        <div class="search-grid">
                            <input 
                                type="text" 
                                name="keyword" 
                                placeholder="Buscar ciudad, estado o área" 
                                value={keyword}
                                class="search-input"
                            />
                            
                            <select name="operation" class="search-select">
                                <option value="">Operación</option>
                                <option value="venta" selected={operation === 'venta'}>Venta</option>
                                <option value="arriendo" selected={operation === 'arriendo'}>Arriendo</option>
                                <option value="arriendo-temporal" selected={operation === 'arriendo-temporal'}>Arriendo Temporal</option>
                            </select>
                            
                            <select name="type" class="search-select" id="type-select">
                                <option value="">Tipo</option>
                                <!-- Will be populated by JS -->
                            </select>
                            
                            <select name="status" class="search-select">
                                <option value="">Estado</option>
                                <option value="disponible" selected={status === 'disponible'}>Disponible</option>
                                <option value="arrendada" selected={status === 'arrendada'}>Arrendada</option>
                                <option value="vendida" selected={status === 'vendida'}>Vendida</option>
                                <option value="reservada" selected={status === 'reservada'}>Reservada</option>
                            </select>
                            
                            <select name="bedrooms" class="search-select">
                                <option value="">Habitaciones</option>
                                {[1,2,3,4,5].map(n => (
                                    <option value={String(n)} selected={bedrooms === String(n)}>{n}+</option>
                                ))}
                            </select>
                            
                            <button type="submit" class="search-btn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Header -->
                <div class="listing-header">
                    <div class="listing-info">
                        <h1 class="listing-title">Listado de Propiedades</h1>
                        <p class="listing-count">Mostrando <strong id="total-count">...</strong> resultados</p>
                        
                        <div class="active-filters" id="active-filters" style="display: none;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Filter Buttons -->
                <div class="filter-buttons" id="filter-buttons">
                    <button class="filter-btn active" data-filter="*">Ver todo</button>
                    <!-- Will be populated by JS -->
                    <span class="filter-divider"></span>
                    <button class="filter-btn filter-btn-blue" data-filter=".status-arriendo">Arriendo</button>
                    <button class="filter-btn filter-btn-blue" data-filter=".status-venta">Venta</button>
                </div>
                
                <!-- Properties Grid with Skeleton Loading -->
                <div class="properties-grid" id="properties-grid">
                    <!-- Skeleton placeholders -->
                    {[1,2,3,4,5,6].map(() => (
                        <div class="property-card skeleton-card">
                            <div class="property-image skeleton-img"></div>
                            <div class="property-content">
                                <div class="skeleton-title"></div>
                                <div class="skeleton-location"></div>
                                <div class="skeleton-features">
                                    <div class="skeleton-feature"></div>
                                    <div class="skeleton-feature"></div>
                                    <div class="skeleton-feature"></div>
                                </div>
                                <div class="skeleton-footer">
                                    <div class="skeleton-price"></div>
                                    <div class="skeleton-btn"></div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
                
            </div>
        </div>
    </section>
</Layout>

<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<script define:vars={{ apiUrl, mapboxToken, keyword, operation, type, status, bedrooms }}>
    const statusColors = {
        'disponible': '#70C2A7',
        'arrendada': '#9ab464',
        'vendida': '#c07b59',
        'reservada': '#cfab59',
    };
    
    const operationColors = {
        'arriendo temporal': '#9ab464',
        'arriendo': '#bfb37b',
        'venta': '#c07b59',
    };

    function formatPrice(price, unit) {
        if (!price) return 'Consultar';
        if (unit === 'UF') {
            return `UF ${parseFloat(price).toLocaleString('es-CL')}`;
        }
        return `$ ${parseInt(price).toLocaleString('es-CL')}`;
    }

    async function loadProperties() {
        const grid = document.getElementById('properties-grid');
        const totalCount = document.getElementById('total-count');
        const filterButtons = document.getElementById('filter-buttons');
        const typeSelect = document.getElementById('type-select');
        
        try {
            const response = await fetch(`${apiUrl}/graphql`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: `{
                        properties(first: 100) {
                            nodes {
                                title
                                uri
                                databaseId
                                slug
                                featuredImage {
                                    node {
                                        sourceUrl
                                        altText
                                    }
                                }
                                realEstatePropertyAddress
                                realEstatePropertyBedrooms
                                realEstatePropertyBathrooms
                                realEstatePropertyGarage
                                realEstatePropertySize
                                realEstatePropertyPriceShort
                                valenciaPriceUnit
                                realEstatePropertyType
                                realEstatePropertyOperation
                                realEstatePropertyLocation
                                propertyStatus
                            }
                        }
                    }`
                })
            });

            const result = await response.json();
            
            if (result.errors) {
                console.error('GraphQL errors:', result.errors);
            }
            
            let allProperties = result.data?.properties?.nodes || [];
            
            // Filter: ONLY show disponible or arrendada
            let properties = allProperties.filter(p => {
                const st = (p.propertyStatus || 'disponible').toLowerCase();
                return st === 'disponible' || st === 'arrendada';
            });
            
            // Extract unique property types
            const typesSet = new Set();
            properties.forEach(p => {
                if (p.realEstatePropertyType) {
                    typesSet.add(p.realEstatePropertyType);
                }
            });
            const propertyTypes = Array.from(typesSet);
            
            // Populate type select
            propertyTypes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.toLowerCase();
                opt.textContent = t.charAt(0).toUpperCase() + t.slice(1);
                if (type === t.toLowerCase()) opt.selected = true;
                typeSelect.appendChild(opt);
            });
            
            // Add type filter buttons
            const divider = filterButtons.querySelector('.filter-divider');
            propertyTypes.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.dataset.filter = `.type-${t.toLowerCase()}`;
                btn.textContent = t.charAt(0).toUpperCase() + t.slice(1);
                filterButtons.insertBefore(btn, divider);
            });
            
            // Apply client-side filters
            if (keyword) {
                properties = properties.filter(p => 
                    p.title?.toLowerCase().includes(keyword.toLowerCase()) ||
                    p.realEstatePropertyAddress?.toLowerCase().includes(keyword.toLowerCase())
                );
            }
            if (operation) {
                properties = properties.filter(p => 
                    p.realEstatePropertyOperation?.toLowerCase() === operation.toLowerCase()
                );
            }
            if (type) {
                properties = properties.filter(p => 
                    p.realEstatePropertyType?.toLowerCase() === type.toLowerCase()
                );
            }
            if (status) {
                properties = properties.filter(p => 
                    p.propertyStatus?.toLowerCase() === status.toLowerCase()
                );
            }
            if (bedrooms) {
                properties = properties.filter(p => 
                    parseInt(p.realEstatePropertyBedrooms || '0') >= parseInt(bedrooms)
                );
            }
            
            // Update count
            totalCount.textContent = properties.length;
            
            // Show active filters
            if (keyword || operation || type || status || bedrooms) {
                const filtersDiv = document.getElementById('active-filters');
                filtersDiv.style.display = 'flex';
                let html = '';
                if (keyword) html += `<span class="filter-tag">Búsqueda: "${keyword}"</span>`;
                if (operation) html += `<span class="filter-tag">${operation}</span>`;
                if (type) html += `<span class="filter-tag">${type}</span>`;
                if (status) html += `<span class="filter-tag">${status}</span>`;
                if (bedrooms) html += `<span class="filter-tag">${bedrooms}+ Hab.</span>`;
                html += `<a href="/propiedades" class="clear-filters">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                    Limpiar
                </a>`;
                filtersDiv.innerHTML = html;
            }
            
            // Render properties
            if (properties.length === 0) {
                grid.innerHTML = '<div class="no-results"><p>No se encontraron propiedades.</p></div>';
            } else {
                grid.innerHTML = properties.map(property => {
                    const typeSlug = property.realEstatePropertyType?.toLowerCase() || '';
                    const operationSlug = property.realEstatePropertyOperation?.toLowerCase() || ''; // Used for class filtering
                    const slug = property.slug || property.uri?.split('/').filter(Boolean).pop() || '';
                    
                    // Status Badge Logic
                    const statusSlug = (property.propertyStatus || 'disponible').toLowerCase();
                    const statusName = statusSlug.charAt(0).toUpperCase() + statusSlug.slice(1);
                    const statusConfig = {
                        'disponible': { bg: '#FFFFFF', text: '#BFB37B', dot: '#BFB37B' }, // White/Gold
                        'arrendada': { bg: '#E7E5E4', text: '#57534E', dot: '#A8A29E' }  // Sand/Taupe
                    };
                    const sColor = statusConfig[statusSlug] || statusConfig['disponible'];

                    const statusBadgeEntry = `
                        <span class="absolute top-4 left-4 z-10 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider shadow-sm" style="background: ${sColor.bg}; color: ${sColor.text}">
                            <span class="w-2 h-2 rounded-full" style="background: ${sColor.dot}"></span>
                            ${statusName}
                        </span>
                    `;

                    // Operation Badge Logic
                    const opSlug = (property.realEstatePropertyOperation || 'Arriendo').toLowerCase();
                    const opName = opSlug.charAt(0).toUpperCase() + opSlug.slice(1);
                    
                    const opConfig = {
                        'arriendo': { bg: '#BFB37B', text: '#FFFFFF', dot: '#FFFFFF' }, // Gold/White
                        'venta':    { bg: '#6B9E7B', text: '#FFFFFF', dot: '#D1E7DD' }  // Soft Sage Green
                    };
                    const oColor = opConfig[opSlug] || opConfig['arriendo'];

                    // Hide operation badge if property is already rented (arrendada)
                    const operationBadgeEntry = statusSlug === 'arrendada' ? '' : `
                        <div class="absolute top-4 right-4 z-10">
                            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider shadow-sm" style="background: ${oColor.bg}; color: ${oColor.text}">
                                 <span class="w-2 h-2 rounded-full" style="background: ${oColor.dot}"></span>
                                ${opName}
                            </span>
                        </div>
                    `;

                    let featuresHtml = '';
                    if (property.realEstatePropertyBedrooms) {
                        featuresHtml += `<span class="feature" title="Habitaciones">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z"/>
                            </svg>
                            ${property.realEstatePropertyBedrooms}
                        </span>`;
                    }
                    if (property.realEstatePropertyBathrooms) {
                        featuresHtml += `<span class="feature" title="Baños">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 7c0-1.1.9-2 2-2s2 .9 2 2H7zm11 6H6v5h12v-5zm0-2c.55 0 1 .45 1 1v7c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-7c0-.55.45-1 1-1h12z"/>
                            </svg>
                            ${property.realEstatePropertyBathrooms}
                        </span>`;
                    }
                    if (property.realEstatePropertyGarage) {
                        featuresHtml += `<span class="feature" title="Estacionamiento">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                            </svg>
                            ${property.realEstatePropertyGarage}
                        </span>`;
                    }
                    if (property.realEstatePropertySize) {
                        featuresHtml += `<span class="feature" title="Superficie">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2zm16 14H5V5h14v14z"/>
                            </svg>
                            ${property.realEstatePropertySize}m²
                        </span>`;
                    }
                    
                    return `<div class="property-card type-${typeSlug} status-${operationSlug}">
                            <div class="property-image relative">
                                ${property.featuredImage?.node?.sourceUrl ? `<img src="${property.featuredImage.node.sourceUrl}" alt="${property.featuredImage.node.altText || property.title}" loading="lazy" />` : '<div class="no-image">Sin imagen</div>'}
                                ${statusBadgeEntry}
                                ${operationBadgeEntry}
                            </div>
                            <div class="property-content">
                                <h3 class="property-title"><a href="/propiedad/${slug}">${property.title}</a></h3>
                                ${property.realEstatePropertyAddress ? `<p class="property-location"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>${property.realEstatePropertyAddress}</p>` : ''}
                                <div class="property-features">${featuresHtml}</div>
                                <div class="property-footer">
                                    <span class="property-price">${formatPrice(property.realEstatePropertyPriceShort, property.valenciaPriceUnit)}</span>
                                    <a href="/propiedad/${slug}" class="btn-details">Detalles<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></a>
                                </div>
                            </div>
                        </div>`;
                }).join('');
            }
            
            // Initialize map with the data
            initPropertiesMap(properties);
            
            // Setup filter buttons
            setupFilterButtons();
            
        } catch (error) {
            console.error('Error loading properties:', error);
            grid.innerHTML = '<div class="no-results"><p>Error cargando propiedades. Intenta recargar la página.</p></div>';
            totalCount.textContent = '0';
        }
    }
    
    function setupFilterButtons() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const filter = btn.getAttribute('data-filter');
                document.querySelectorAll('.property-card').forEach(card => {
                    card.style.display = (filter === '*' || card.matches(filter)) ? 'block' : 'none';
                });
            });
        });
    }

    async function initPropertiesMap(properties) {
        if (!window.mapboxgl) {
            const script = document.createElement('script');
            script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js';
            document.head.appendChild(script);
            await new Promise(resolve => script.onload = resolve);
        }

        window.mapboxgl.accessToken = mapboxToken;

        const map = new window.mapboxgl.Map({
            container: 'properties-map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [-70.6693, -33.4489],
            zoom: 11
        });

        map.addControl(new window.mapboxgl.NavigationControl(), 'top-right');

        const bounds = new window.mapboxgl.LngLatBounds();
        let hasCoords = false;

        properties.forEach(property => {
            const loc = property.realEstatePropertyLocation;
            if (!loc) return;

            let lat, lng;
            if (typeof loc === 'string' && loc.includes(',')) {
                const coords = loc.split(',');
                lat = parseFloat(coords[0].trim());
                lng = parseFloat(coords[1].trim());
            } else if (typeof loc === 'object' && loc.location) {
                const coords = loc.location.split(',');
                lat = parseFloat(coords[0].trim());
                lng = parseFloat(coords[1].trim());
            }

            if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;

            hasCoords = true;
            bounds.extend([lng, lat]);

            const el = document.createElement('div');
            el.className = 'map-marker';
            el.innerHTML = '<div class="marker-inner"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div>';

            const price = property.realEstatePropertyPriceShort;
            const unit = property.valenciaPriceUnit;
            const formattedPrice = price ? (unit === 'UF' ? `UF ${price}` : `$ ${parseInt(price).toLocaleString('es-CL')}`) : '';

            const popupHTML = `
                <div class="map-popup">
                    ${property.featuredImage?.node?.sourceUrl ? `<div class="popup-img"><img src="${property.featuredImage.node.sourceUrl}" /></div>` : ''}
                    <div class="popup-body">
                        <h4>${property.title}</h4>
                        ${property.realEstatePropertyAddress ? `<p class="popup-addr">${property.realEstatePropertyAddress}</p>` : ''}
                        <div class="popup-features">
                            ${property.realEstatePropertyBedrooms ? `<span>${property.realEstatePropertyBedrooms} Hab</span>` : ''}
                            ${property.realEstatePropertyBathrooms ? `<span>${property.realEstatePropertyBathrooms} Baño</span>` : ''}
                            ${property.realEstatePropertySize ? `<span>${property.realEstatePropertySize} m²</span>` : ''}
                        </div>
                        ${formattedPrice ? `<p class="popup-price">${formattedPrice}</p>` : ''}
                        <a href="${property.uri}" class="popup-link">Ver detalles →</a>
                    </div>
                </div>
            `;

            const popup = new window.mapboxgl.Popup({ offset: 35, maxWidth: '300px' }).setHTML(popupHTML);
            new window.mapboxgl.Marker(el).setLngLat([lng, lat]).setPopup(popup).addTo(map);
        });

        if (hasCoords && !bounds.isEmpty()) {
            map.fitBounds(bounds, { padding: 60, maxZoom: 14 });
        }
    }

    // Load properties when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadProperties);
    } else {
        loadProperties();
    }
</script>


